

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DataPulse - Real-Time Configuration</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/datapulse_styles.css') }}">
</head>
<body>
  <header class="dp-header">
<div class="di-logo">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" style="height:32px; vertical-align:middle; margin-right:8px;">
      Testify
    </div>
    <nav class="dp-nav" style="display: inline-block; margin-left: 24px; vertical-align: middle;">
      <a href="/">Overview</a>
    </nav>
<div class="profile-dropdown" style="position: relative;">
      <i class="fas fa-user-circle" id="profile-icon" style="font-size: 28px; cursor: pointer;"></i>
      <div class="dropdown-menu" id="dropdown-menu" style="display: none; position: absolute; right: 0; top: 36px; background: #fff; border: 1px solid #ced4da; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); min-width: 120px; z-index: 100;">
      <a href="/profile" style="display: block; padding: 8px 16px; color: #222; text-decoration: none;">Profile</a>
      <hr style="margin: 0;">
      <a href="/logout" style="display: block; padding: 8px 16px; color: #222; text-decoration: none;">Logout</a>
      </div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
      const profileIcon = document.getElementById('profile-icon');
      const dropdownMenu = document.getElementById('dropdown-menu');
      profileIcon.addEventListener('click', function(e) {
        e.stopPropagation();
        dropdownMenu.style.display = dropdownMenu.style.display === 'none' ? 'block' : 'none';
      });
      document.addEventListener('click', function(e) {
        if (!profileIcon.contains(e.target)) {
        dropdownMenu.style.display = 'none';
        }
      });
      });
    </script>
    <!-- Font Awesome for user icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">  </header>
  <main>
    <section class="dp-connect-section">
      <h2>Connect to a Live Data Source</h2>
      <p>Publish a Google Sheet as a CSV and paste the public URL below to create a live dashboard.</p>
      <p>demo api ðŸ‘‰ full link here: <br>
https://docs.google.com/spreadsheets/d/e/2PACX-1vQozw2tZF6djWVap61xiH_HzOnuIC9vqa3eTCC0bzU7wKZiADHk1wrW37yBzKv6Pox7NtEPqSy5ZkZ1/pub?output=csv</p>

      <div id="live-fields" class="dp-form-fields">
        <div class="dp-form-group">
          <label for="dp-api-endpoint">Live Data URL (e.g., Google Sheet CSV Link)</label>
          <input type="text" id="dp-api-endpoint" placeholder="Paste your published Google Sheet URL here">
        </div>
      </div>

      <div id="connection-status" style="margin-top: 15px; color: #ffc107;"></div>

      <div class="dp-button-group">
        <button type="button" class="dp-test-button" onclick="testAndConnect()">Connect to Live Dashboard</button>
      </div>
    </section>
  </main>

  <script>
    async function testAndConnect() {
      const apiUrl = document.getElementById('dp-api-endpoint').value;
      const statusDiv = document.getElementById('connection-status');

      if (!apiUrl) {
        statusDiv.textContent = 'Please enter a URL.';
        return;
      }

      statusDiv.textContent = 'Testing connection...';

      try {
        // 1. Call our secure backend to test the URL
        const response = await fetch('/api/fetch_live_data', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ url: apiUrl }),
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to connect.');
        }

        // 2. If the connection is successful, redirect to the dashboard
        statusDiv.textContent = 'Connection successful! Redirecting to dashboard...';

        // Pass the live URL as a parameter to the dashboard
        window.location.href = '/dashboard/?live_data_url=' + encodeURIComponent(apiUrl);

      } catch (error) {
        statusDiv.textContent = 'Error: ' + error.message;
      }
    }
  </script>
</body>
</html>
