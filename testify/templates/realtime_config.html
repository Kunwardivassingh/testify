

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DataPulse - Real-Time Configuration</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/datapulse_styles.css') }}">
</head>
<body>
  <header class="dp-header">
    <div class="dp-logo">DataPulse</div>
    <nav class="dp-nav">
      <a href="/dashboard/">Dashboards</a>
      <a href="#">Data Sources</a>
    </nav>
    <div class="dp-user-icon"></div>
  </header>
  <main>
    <section class="dp-connect-section">
      <h2>Connect to a Live Data Source</h2>
      <p>Publish a Google Sheet as a CSV and paste the public URL below to create a live dashboard.</p>

      <div id="live-fields" class="dp-form-fields">
        <div class="dp-form-group">
          <label for="dp-api-endpoint">Live Data URL (e.g., Google Sheet CSV Link)</label>
          <input type="text" id="dp-api-endpoint" placeholder="Paste your published Google Sheet URL here">
        </div>
      </div>

      <div id="connection-status" style="margin-top: 15px; color: #ffc107;"></div>

      <div class="dp-button-group">
        <button type="button" class="dp-test-button" onclick="testAndConnect()">Connect to Live Dashboard</button>
      </div>
    </section>
  </main>

  <script>
    async function testAndConnect() {
      const apiUrl = document.getElementById('dp-api-endpoint').value;
      const statusDiv = document.getElementById('connection-status');

      if (!apiUrl) {
        statusDiv.textContent = 'Please enter a URL.';
        return;
      }

      statusDiv.textContent = 'Testing connection...';

      try {
        // 1. Call our secure backend to test the URL
        const response = await fetch('/api/fetch_live_data', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ url: apiUrl }),
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to connect.');
        }

        // 2. If the connection is successful, redirect to the dashboard
        statusDiv.textContent = 'Connection successful! Redirecting to dashboard...';

        // Pass the live URL as a parameter to the dashboard
        window.location.href = '/dashboard/?live_data_url=' + encodeURIComponent(apiUrl);

      } catch (error) {
        statusDiv.textContent = 'Error: ' + error.message;
      }
    }
  </script>
</body>
</html>