<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>testify</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/datainsights_styles.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
  <header class="di-header">
    <div class="di-logo">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" style="height:32px; vertical-align:middle; margin-right:8px;">
      Testify
    </div>
    <nav class="di-nav">
      <a href="/">Overview</a>
      <a href="/dashboard">Dashboards</a>
      <a href="/reports">Reports</a>
    </nav>
    <div class="profile-dropdown" style="position: relative;">
      <i class="fas fa-user-circle" id="profile-icon" style="font-size: 28px; cursor: pointer;"></i>
      <div class="dropdown-menu" id="dropdown-menu" style="display: none; position: absolute; right: 0; top: 36px; background: #fff; border: 1px solid #ced4da; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); min-width: 120px; z-index: 100;">
        <a href="/profile" style="display: block; padding: 8px 16px; color: #222; text-decoration: none;">Profile</a>
        <hr style="margin: 0;">
        <a href="/logout" style="display: block; padding: 8px 16px; color: #222; text-decoration: none;">Logout</a>
      </div>
    </div>
  </header>
  <main>
    <section class="di-upload-section">
      <h2>Upload Data</h2>
      <p>Upload Excel or CSV files to analyze your test data.</p>
      <!-- 1st: See demo report -->
<p><a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vQozw2tZF6djWVap61xiH_HzOnuIC9vqa3eTCC0bzU7wKZiADHk1wrW37yBzKv6Pox7NtEPqSy5ZkZ1/pub?output=csv" target="_blank">
  see demo report and make sure your report should also like that col. names
</a></p>

      <div class="di-upload-area">
        <div class="di-drop-zone" id="di-drop-zone">
          <div class="di-cloud-icon"></div>
          <p>Drag and drop your file here</p>
          <p>Or, click the button to browse for a file on your computer.</p>
          <input type="file" id="di-file-input" accept=".xlsx,.xls,.csv" style="display: none;">
          <button class="di-browse-button" onclick="document.getElementById('di-file-input').click()">Browse Files</button>
        </div>
      </div>
      <div id="di-sample-data" class="di-file-preview" style="display: none;">
        <div class="di-table-container">
          <table id="di-data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Test Case ID</th>
                <th>Product Name</th>
                <th>Test ID</th>
                <th>Test Type</th>
                <th>Status</th>
                <th>Execution Date</th>
                <th>Frequency</th>
                <th>Tester</th>
                <th>Test Duration</th>
              </tr>
            </thead>
            <tbody id="di-table-body"></tbody>
          </table>
        </div>
      </div>
      <button class="di-upload-process-button" id="di-process-button" onclick="uploadAndRedirect()" style="display: none;">Upload and Process</button>
    </section>
  </main>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const dropZone = document.getElementById('di-drop-zone');
    const fileInput = document.getElementById('di-file-input');
    const sampleDataDiv = document.getElementById('di-sample-data');
    const processButton = document.getElementById('di-process-button');
    const tableBody = document.getElementById('di-table-body');

    // Dropdown menu logic
    document.addEventListener('DOMContentLoaded', function() {
        const profileIcon = document.getElementById('profile-icon');
        const dropdownMenu = document.getElementById('dropdown-menu');
        if (profileIcon) {
            profileIcon.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdownMenu.style.display = dropdownMenu.style.display === 'none' ? 'block' : 'none';
            });
        }
        document.addEventListener('click', function(e) {
            if (profileIcon && !profileIcon.contains(e.target)) {
                dropdownMenu.style.display = 'none';
            }
        });
    });

    // File handling logic
    dropZone.addEventListener('dragover', (e) => e.preventDefault());
    dropZone.addEventListener('dragleave', (e) => e.preventDefault());
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', (e) => {
      if (fileInput.files.length > 0) handleFile(fileInput.files[0]);
    });

    function excelDateToJSDate(serial) {
      if (typeof serial !== 'number') return null;
      const excelEpoch = new Date(Date.UTC(1899, 11, 30));
      const delta = serial * 24 * 60 * 60 * 1000;
      return new Date(excelEpoch.getTime() + delta).toISOString().split('T')[0];
    }

    function handleFile(file) {
      const fileName = file.name;
      const fileSize = (file.size / (1024 * 1024)).toFixed(2) + ' MB';
      const reader = new FileReader();

      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
        const rows = [];

        worksheet.forEach((row, index) => {
          if (index === 0) return;
          rows.push({
            id: row[0] || null,
            report_id: row[1] || null,
            product_name: row[2] || '',
            test_id: row[3] || '',
            test_type: row[4] || '',
            status: row[5] || 'Pending',
            execution_date: excelDateToJSDate(row[6]),
            frequency: parseInt(row[7]) || 0,
            tester: row[8] || '',
            test_duration: parseInt(row[9]) || 0
          });
        });

        tableBody.innerHTML = '';
        rows.forEach(row => {
          const tr = document.createElement('tr');
          Object.values(row).forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell || '-';
            tr.appendChild(td);
          });
          tableBody.appendChild(tr);
        });

        sampleDataDiv.style.display = 'block';
        processButton.style.display = 'block';
        window.uploadedData = { rows, fileName, fileSize };
      };
      reader.readAsArrayBuffer(file);
    }

    function uploadAndRedirect() {
      if (window.uploadedData) {
        fetch('/api/upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            // THIS IS THE FIX: Send the data in the correct structure
            rows: window.uploadedData.rows,
            filename: window.uploadedData.fileName,
            filesize: window.uploadedData.fileSize,
            user_id: 1, // Replace with dynamic user ID from session
            source_type: 'upload'
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
              console.error('Upload Error:', data.error);
              alert('An error occurred during upload: ' + data.error);
          } else {
              console.log('Upload Success:', data);
              window.location.href = '/reports'; // Redirect to reports page
          }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('A network error occurred. Please try again.');
        });
      }
    }
  </script>
</body>
</html>
